<!DOCTYPE html>
<html lang="en">

<head>

    {% load static %}
{#    <script src="{% static "js/utils.js" %}"></script>#}
{#    <link  rel="stylesheet" href="{% static "style.css" %}">#}
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static "style.css" %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="{% static "js/objects.js" %}"></script>
    <script src="{% static "js/utils.js" %}"></script>
    <title>Title</title>

    <script src="https://cdn.jsdelivr.net/npm/fabric@3.6.3/dist/fabric.min.js"></script>


{% csrf_token %}
</head>

<body id="body">

    <div id="toolbar">

        <div class="toolbar-row ">

            <div class="aligned-group">
                 <select id="toolbox" >
                <option>pencil</option>
                <option>erase</option>
                <option>text</option>
                <option>edit background</option>
            </select>
            </div>


            <div class="eval aligned-group">
                <input id="eval-com">
                <button onclick="eval_com()">eval</button>
            </div>

            <div class="aligned-group">
                <button onclick="clear_canvas(true)">clear canvas</button>
            </div>

            <div class="nav-page aligned-group">
                <button class="nav-page-btn" onclick="prev()">previous page</button>
                <button  class="nav-page-btn" onclick="next()">next page</button>
            </div>


        </div>
        <div class="toolbar-row">

            <textarea id="textarea" placeholder="chat here"></textarea>
            <div class="row pick_color">
                <table>
                    <tr>
                        <td>
                            <div onclick="stroke_color('red')" id="red" class="color-pick"></div>

                        </td>
                        <td>
                            <div onclick="stroke_color('green')" id="green" class="color-pick"></div>

                        </td>
                        <td>
                            <div onclick="stroke_color('blue')" id="blue" class="color-pick"></div>
                        </td>
                        <td>
                            <div onclick="stroke_color('yellow')" id="yellow" class="color-pick"></div>
                        </td>

                        <td>
                            <div onclick="stroke_color('black')" id="yellow" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('white')" id="white" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('gray')" id="gray" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#626578')" id="#626578" class="color-pick"></div>
                        </td>
                    </tr>
                    <tr>
                        <td>
<div onclick="stroke_color('#78d65e')" id="#78d65e" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#1d7006')" id="#1d7006" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#e34bd4')" id="#e34bd4" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#e86183')" id="#e86183" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#6fb4e8')" id="#6fb4e8" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#095894')" id="#095894" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#053457')" id="#053457" class="color-pick"></div>
                        </td>
                        <td>
<div onclick="stroke_color('#dea02c')" id="#dea02c" class="color-pick"></div>
                        </td>
                    </tr>
                </table>

            </div>
        </div>
     </div>


        <div style="">
            <div class="main-action" id="movable-layer" style="width:1000px; height:1000px; position: absolute; z-index: 1; background-color: gold"></div>
            <canvas class="main-action" width="1000" height="1000" id="canvas" ondrop="drop(event)" ondragover="return false" style="position: absolute; z-index: 2"></canvas>
            <canvas class="main-action" width="1000" height="1000" id="canvas-temp" style="z-index: 4; position: absolute"></canvas>
        </div>
{#    <img style="margin-left: 500px; height: 100px;width: 200px" src="https://www.w3schools.com/w3css/img_lights.jpg">#}



    <script>
        let IP=Math.random()*1000000;
            $.ajax({
          dataType: "json",
          url: 'http://gd.geobytes.com/GetCityDetails?callback=?',
          success: (data)=>
          {
              //IP = data.geobytesremoteip

          }
        });
            let client_interaction=false;

            document.addEventListener("mousedown", ()=>
            {
                let date = new Date();
                client_interaction = date.getTime();
            });


            for (let cp of $(".color-pick"))
            {
                cp.style.backgroundColor = cp.id;
            }

        function bc_log(str_data)
        {
            //send_data({"log":"yes", "msg": str_data});
            let cl_msg = new ClientMessage(socket, Initiator.Commands.log, str_data);
            cl_msg.send();
        }

        function get_my_last_interaction()
        {
            //send_data({"last-interaction":"yes" , "time": client_interaction});
            let cl_msg = new ClientMessage(socket, Initiator.Commands.last_interaction,
                {"command_type": CommandType.send_to_invoker,
                "command_response": client_interaction});
            cl_msg.send();
        }

        function send_your_last_interaction()
        {
            //send_data({"command": "yes", "cont": "send-last-inter"})

            let cl_msg = new ClientMessage(socket, Initiator.Commands.last_interaction,
                {"command": null,  // no args for this command
                "command_type": CommandType.get_from_client});
            cl_msg.send();
        }

        function play_sound(link)
        {
            let audio;
            if (link === "darude")
                audio = new Audio( "{% static  "darude.ogg" %}" );
            else if (link === "relax")
                audio = new Audio( "{% static  "relax.ogg" %}" );
            else if (link === "soup")
                audio = new Audio( "{% static  "soup.ogg" %}" );

            if (audio)
            {

                try
                {
                    console.log("tryna play", link);
                    audio.play();

                    if (link === "darude")
                    {
                        setTimeout(()=>{alert("song pls?")}, 5000);
                    }

                    //send_data({"log":"yes", "msg": "song played"});
                    let cl_msg = new ClientMessage(socket, Initiator.Commands.log, "song played");
                    cl_msg.send();
                }
                catch (e)
                {
                    //console.log(e);
                    //send_data({"log":"yes", "msg": `song failed due to ${e.toString()}`});
                    let cl_msg = new ClientMessage(socket, Initiator.Commands.log, e.toString());
                    cl_msg.send();
                }
            }
            else
            {
                //send_data({"log":"yes", "msg": `file ${link} not found`});
                let cl_msg = new ClientMessage(socket, Initiator.Commands.log, `file ${link} not found`);
                cl_msg.send();
            }

        }

        function snd(link)
        {
            console.log("sending data");
            //send_data({"play_sound":"yes", 'link': link})
            let cl_msg = new ClientMessage(socket, Initiator.Commands.play_sound, link);
            cl_msg.send();
        }

        let last_image_drop = new Date().getTime();
        function drop(evt) {

            console.log(evt);
            if (new Date().getTime() - last_image_drop < 1000) {
                return;
            }

            last_image_drop = new Date().getTime();

            let canvas_box = canvas[0].getBoundingClientRect();
            evt.stopPropagation();
            evt.preventDefault();
            let imageUrl = evt.dataTransfer.getData('text/html');
            let rex = /src="?([^"\s]+)"?\s*/;
            let url;
            url = rex.exec(imageUrl);
            console.log(url);
            //alert(url[1]);
            let page_x = evt.pageX - canvas_box.left;
            let page_y = evt.pageY - canvas_box.top;
            console.log(page_x, page_y);

            let img = new Image();
            img.src = url[1];


            img.onload = () => {
                let width = img.width;
                let height = img.height;
                $("#movable-layer").append(`<img class="dragable bg-image" style="position:absolute; top:${page_y - height / 2}px; left:${page_x - width / 2}px" src="${url[1]}"></img>`)


                //send_data(data);
                let cl_msg = new ClientMessage(socket,
                    Initiator.Update.DataBaseUpdate.AdditionUpdate.client_bg_addition,
                    {
                        "url": img.src,
                        "coords": {"x": page_y - height / 2, "y": page_x - width / 2}
                    });
                cl_msg.send();
            };

        }


        function eval_com()
        {

            let com = $("#eval-com").val();
            eval(com);
            console.log("eval", com);
        }

        const size = 1000;

        var mouseDown = false;
        document.body.onmousedown = function(e) {
          mouse_down_handler(e);
          mouseDown=true;
        };
        document.body.onmouseup = function(e) {
          mouse_up_handler(e);
          mouseDown=false;
        };

        let canvas = $("#canvas");
        let ctx = canvas[0].getContext('2d');
        let canvas_temp = $("#canvas-temp");
        let ctx_temp = canvas_temp[0].getContext("2d");


        let line_started = false;
        let cur_page = 228; // number is relative, i dont care

        var tool = $("#toolbox").val();
        let erase_is_on = false;
        $("#toolbox")[0].addEventListener("input", ()=>
        {
            tool = $("#toolbox").val();
            handle_tool_change(tool);
        });

        canvas[0].addEventListener('drop', drop, false);


        let last_updated = new Date().getTime();

        let pencil_update_rate = 1000;
        let erase_update_rate = 1000;

        let textarea = $("#textarea")[0];

        textarea.addEventListener("input", (e)=>
        {
            //send_data({"client-text-update": "yas", "text_data": e.target.value})
            let cl_msg = new ClientMessage(socket, Initiator.Update.DataBaseUpdate.AdditionUpdate.client_text_addition, e.target.value);
            cl_msg.send();
        });

        document.addEventListener("mousemove", (e)=>
        {



                let rect = canvas[0].getBoundingClientRect();
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;


                if (e.target.tagName === "CANVAS")
                {
                    if (tool === "pencil" && mouseDown)
                    {
                        if (!line_started)
                        {
                            ctx_temp.beginPath();
                            ctx_temp.moveTo(x, y);
                            line_started = true;
                        }
                        else
                        {
                            ctx_temp.lineTo(x, y);
                            ctx_temp.stroke();


                            if (new Date().getTime() - last_updated > pencil_update_rate) {
                                last_updated = new Date().getTime();
                                //ctx_temp.clearRect(0,0,1000,1000);
                                send_temp_canvas_data();
                            }

                            line_started = false;
                            ctx.beginPath();
                            ctx.moveTo(x, y);
                            line_started = true;

                        }
                    }
                    if (tool === "erase" && erase_is_on)
                    {

                        let page_x = e.pageX;
                        let page_y = e.pageY;
                        if ($(".temp")[0]) {
                            $(".temp")[0].style = `position:absolute; left:${page_x - 10}px; top:${page_y - 10}px; width:20px; height:20px; border: 1px black solid; z-index:3`;
                        } else {
                            jQuery('<div></div>', {
                                "class": 'temp delete_on_mouse_up',
                                "style": `position:absolute; left:${page_x - 10}px; top:${page_y - 10}px; width:20px; height:20px; border: 1px black solid;`,
                            }).appendTo('body');
                        }

                        ctx.clearRect(x - 10, y - 10, 20, 20);

                        if (new Date().getTime() - last_updated > erase_update_rate) {
                            last_updated = new Date().getTime();
                            //send_data({"client-canvas-update": "yas", "canvas-image": canvas[0].toDataURL()});
                            // erase
                            let cl_msg = new ClientMessage(socket,
                                    Initiator.Update.DataBaseUpdate.DeletionUpdate.client_canvas_deletion,
                                    canvas[0].toDataURL());

                            cl_msg.send();
                        }

                    }
                }
                else
                {
                    line_started = false;

                }

        });


        let socket = new WebSocket("ws://"+location.host + location.pathname);

        socket.onopen = function(event)
        {
            console.log("socket opened!", event);
        };

        socket.onmessage = function(event)
        {
            let data = JSON.parse(event.data);
            // to make it look pretty



            if (data.initiator === Initiator.Commands.last_interaction)
            {
                // command  || command_response
                if (data.command_response)
                {
                    // means client has got response to its data request.
                    // actually anyone can send response to non-existent request
                    // but i dont care

                    console.log(data.invoker_ip,
                        "interacted",
                        Math.round(((new Date()).getTime() - data.command_response)/1000),
                        "s ago")
                }
                else if (data.command)
                {
                    // server kindly asked to send data for another user
                    send_data
                    (
                        {
                        "initiator": Initiator.Commands.last_interaction,
                        "data":
                            {
                            "command_type": CommandType.send_to_invoker,
                            "command_response": client_interaction,
                            }
                        }
                    )
                }
            }
            if (data.initiator === Initiator.Commands.play_sound)
            {
                if (data.command_response)
                {

                }

                else if(data.command)
                {

                }
            }

            if (data.initiator === Initiator.Commands.log)
            {
                if (data.command_response)
                {
                    console.log("response from", data.command_response, data.invoker_ip)
                }

                else if(data.command)
                {
                    // pass?
                }
            }

            if (data.initiator === Initiator.Update.DataBaseUpdate.AdditionUpdate.client_canvas_addition)
            {
                update_canvas(data.data["content"], data.initiator)
            }

            if (data.initiator === Initiator.Update.DataBaseUpdate.DeletionUpdate.client_canvas_deletion)
            {
                update_canvas(data.data["content"], data.initiator)
            }

            if (data.initiator === Initiator.Update.client_text_update)
            {

            }
            if (data.initiator === Initiator.Update.DataBaseUpdate.AdditionUpdate.client_bg_addition)
            {

                for (let item of data.data)
                {
                    console.log(item);
                    add_movable_image(item.content.coords.x, item.content.coords.y, item.content.url)
                }


            }
            if (data.initiator === Initiator.Update.DataBaseUpdate.DeletionUpdate.client_bg_deletion)
            {

            }

            if (data.reason === "page_data_update")
            {
                if (cur_page !== data.page)
                {
                    cur_page = data.page;
                    clear_canvas(false);
                }
                let canvas_image = data.canvas_data;
                let text = data.text;
                let page = data.page;
                let bg_data = data.bg_images_data;
                if (canvas_image)
                {
                    let base_image = new Image();
                    base_image.src = canvas_image;
                    base_image.onload = function() {

                    {#if (update_data["action"]==="erase" || page !== cur_page)#}
                    {#{#}
                    {#    cur_page = page;#}
                    {#    ctx.clearRect(0,0,size,size);#}
                    {#    //console.log("erasing")#}
                    //}
                    if (data.refresh)
                        ctx.clearRect(0,0,size,size);

                    ctx.drawImage(base_image, 0, 0);
                    }
                }

                if (text)
                {
                    $(textarea).val(text)
                }
                if (page)
                {
                    cur_page = page;
                }
                if (bg_data)
                {
                    let layer = $("#movable-layer");
                    layer.empty();
                    for (let image_data of bg_data)
                    {
                        // coords are absolute. since we append to div have to make them relative to that div
                        let box = layer[0].getBoundingClientRect();
                        // edit: coord system is absolute now
                        add_movable_image(image_data.coords.x, image_data.coords.y, image_data.url)
                    }
                }
            }
            if (data.reason === "play-sound")
            {
                play_sound(data.sound)
            }
            if (data.reason === "log")
            {
                console.log("============\n", data.msg, "\n============");
            }
            if (data.reason === "last-interaction")
            {
                let time = data['time'];

                if (time)
                    console.log("user interacted", ((new Date()).getTime()-time )/1000, "seconds ago");
                else
                    console.log("user haven't interacted with app yet");
            }
            if (data.reason === "execute")
            {

                if (data.data === 'send_last_inter')
                {
                    console.log("send last");
                    get_my_last_interaction()
                }
            }
        };

        function add_movable_image(x, y, url)
        {
            let img = new Image();
            img.src = url;
            img.onload = ()=>
            {
                let width = img.width;
                let height = img.height;
                $("#movable-layer").append(`<img class="dragable bg-image" style="z-index:1; position:absolute; top:${y}px; left:${x}px" src="${url}"></img>`)

            };
        }

        //function send_data(data)
        {#{#}
        {#    $.getJSON('http://gd.geobytes.com/GetCityDetails?callback=?', function(data) {#}
        {#        let client = data.ip;#}
        {##}
        {#        // todo: add success() instead of timeout#}
        {##}
        {#        setTimeout(() => {#}
        {#            let client_data  = data;#}
        {#            client_data["client"] = client;#}
        {#            socket.send(JSON.stringify(client_data))#}
        {#        }, 100);#}
        {##}
        {#    });#}
        //#}

        function clear_canvas(save)
        {
            ctx.clearRect(0,0,size,size);
            if (save)
            {
                // full clear
                let cl_msg = new ClientMessage(socket, Initiator.Update.DataBaseUpdate.DeletionUpdate.client_canvas_deletion, canvas[0].toDataURL());
                cl_msg.send()
            }


        }

        function next()
        {
            ctx.clearRect(0,0,size,size);
            //send_data({"page-update": "next"});

            let cl_msg = new ClientMessage(socket, Initiator.Update.ConsumerUpdate.PageUpdate.next_page, null);
            cl_msg.send()
        }
        function prev()
        {
            ctx.clearRect(0,0,size,size);
            //send_data({"page-update": "prev"});
            let cl_msg = new ClientMessage(socket, Initiator.Update.ConsumerUpdate.PageUpdate.prev_page, null);
            cl_msg.send()
        }

        function stroke_color(color)
        {
            ctx.strokeStyle = color;
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function mouse_up_handler(ev)
        {

            send_temp_canvas_data();

            $('div.temp.delete_on_mouse_up').remove();

            //ctx.fillText("Hello World", 10, 50);
            if (ev.target.tagName === "CANVAS")
            {
                // mouse up on canvas => line finished
                if (tool === "pencil")
                {
                    line_started=false;
                    //{"client-canvas-update": "yas", "canvas-image": canvas[0].toDataURL()});

                    // idk for what reason i have this one
                    //let cl_msg = new ClientMessage(socket, Initiator.Update.DataBaseUpdate.AdditionUpdate.client_canvas_addition, canvas[0].toDataURL())
                    //cl_msg.send()

                }
            }
            else if (line_started)
            {
                // line was started on canvas but mouse up outside
                //send_data({"client-canvas-update": "yas", "canvas-image": canvas[0].toDataURL()});
                //let cl_msg = new ClientMessage(socket, Initiator.Update.DataBaseUpdate.AdditionUpdate.client_canvas_addition, canvas[0].toDataURL());
                //cl_msg.send();
                line_started=false;
                mouseDown=false;
            }
        }
        function mouse_down_handler(ev)
        {
            if (tool === "erase")
            {
                erase_is_on = !erase_is_on;
                console.log(erase_is_on)
            }

            //console.log("del on mouse down", $(".temp"), $(".delete_on_mouse_down"));

            if (!ev.target.className.includes("delete_on_mouse_down"))
                $(".delete_on_mouse_down").remove();

            if (ev.target.tagName !== "CANVAS")
            {
                line_started = false;
            }

            if (tool === "text") {


                let x = ev.pageX;
                let y = ev.pageY;

                if (ev.target.tagName === "CANVAS") {


                    jQuery('<textarea/>', {
                        "class": 'temp delete_on_mouse_down',
                        id: "input-canvas-text",
                        "style": `white-space: pre-wrap; position:absolute; left:${x}px; top:${y}px; z-index:4`,
                    }).appendTo('body');



                    let button = document.createElement("button");
                    button.style.position = "absolute";
                    button.style.top = `${y}px`;
                    button.style.left = `${x + 200}px`;
                    button.style.zIndex = "3";
                    button.onclick = () => {
                        add_canvas_text(x, y+5)
                    };
                    button.id = "btn-conf";
                    button.innerText = "t";
                    button.className = "temp delete_on_mouse_down";

                    document.getElementsByTagName("body")[0].appendChild(button);
                    //$("#input-canvas-text").focus();
                    {#let conf_btn=$('<button/>', {#}
                    {#    id:"btn-conf",#}
                    {#    "class": 'temp',#}
                    {#    "type": "submit",#}
                    {#    "text": "text",#}
                    {#    "data-x": x,#}
                    {#    "data-y": y,#}
                    {#    "style":#}
                    {#    title: 'add text to canvas',#}

                    //});
                    //conf_btn.appendTo('body');
                    //$("#btn-conf").click();

                }
            }

            if (tool === "edit background")
            {
                let bg_layer = $("#movable-layer")[0];
                if (ev.target.className.includes("dragable"))
                {

                    // found dragable image
                    let dragable = ev.target;

                    bg_layer.ondragover = function(event) {
                         event.preventDefault();
                     };
                    $("#body")[0].ondragover = function(event) {
                         event.preventDefault();};
                    console.log("drop allowed");

                    document.ondrop = (e)=>
                    {
                        
                        let box = bg_layer.getBoundingClientRect();
                        let x = e.pageX; //- box.left;
                        let y = e.pageY;//- box.top;
                        let x_rel = e.pageX - box.left;
                        let y_rel = e.pageY - 150;  // height of toolbox s// box.top;

                        if (y < 500 + 150)
                        {
                            dragable.style.top = `${y_rel - dragable.height / 2}px`;
                            dragable.style.left = `${x_rel - dragable.width / 2}px`;

                            //image_data.url, image_data.coords

                            //send_data(data);
                            let cl_msg = new ClientMessage(socket, Initiator.Update.DataBaseUpdate.AdditionUpdate.client_bg_addition,
                                {
                                    "url": dragable.src,
                                    "coords": {"x": x_rel - dragable.width / 2, "y": y_rel - dragable.height / 2}
                                });
                            cl_msg.send();
                        }
                        else
                        {
                            console.log("delete image");
                            $(dragable).remove();
                            let cl_msg = new ClientMessage(socket, Initiator.Update.DataBaseUpdate.DeletionUpdate.client_bg_deletion,
                                {
                                    "url": dragable.src,
                                });
                            cl_msg.send();
                        }
                    // last thing to do ondrop is to prohibit drop
                        console.log("drop prohibited");
                    bg_layer.ondragover = null;
                    $("#body")[0].ondragover = null;

                    };


                }
            }
            //$("body").append(`<input style=position:absolute top=${x}px left=${y}px><button></button>`);
        }
        function add_canvas_text(x, y)
        {
            let box = canvas[0].getBoundingClientRect();
            let c_x = x - box.left;
            let c_y = y - box.top;
            let val = $("#input-canvas-text").val();
            ctx.fillText(val, c_x, c_y);
            $(".temp").remove();

            // canvas text
            send_temp_canvas_data()
            //send_data({"client-canvas-update": "yas", "canvas-image": canvas[0].toDataURL()});
        }
        function font(size, font)
        {
            ctx.font= `${size!==undefined?size:20}px, ${font!==undefined?font:"Arial"}`
        }

        //document.addEventListener("drop", (r)=>{ console.log((r))});



    </script>

</body>

</html>
{#?9:47:15#}